# GSP487 Google Assistant: Build a Youtube Entertainment App

_last update: 2020-12-28_

## Build an Action

Open [Actions on Google Developer Console](http://console.actions.google.com/) in a new tab.

> **Check my progress**
> Create a Dialogflow Agent traverse from Action Project

## Build the Default Welcome Intent

1. Go to **Fulfillment**, and enter the dummy URL:

    `https://google.com`

2. **Indents** > **Default Welcome Intent**

3. **Responses** > **ðŸš®Trash icon**.

4. **ADD RESPONSES** > **Text response**

    `Hello there and welcome to Youtube Entertainment! What artist are you searching for?`

> **Check my progress**
> Configure the Default Welcome Intent

## Build a Custom Intent

1. **Indents** > **+** icon

    `youtube`

2. **Training phrases** > **Add Training Phrases**

    `Kanye West` | `@sys.any`
    `Dua Lipa`
    `Lil Baby`

3. **Action and parameters** > **MANAGE PARAMETERS AND ACTION**

4. check the **REQUIRED**

5. **Define prompts** > 

    `Who do you want to look up?`

6. **Fullfilment** > **Enable webhook call for this intent**

7. **Responses** > **Google Assistant** tab > + `Google Assistant`

8. Click **Set this intent as end of conversation**

> **Check my progress**
> Build the Custom Intent (name: youtube)

## Enable the API

1. **APIs & Services** > **Credentials** > **API Key**

## Initialize and Configure a Cloud Function

1. **Cloud Functions** > **Create function**

    name: `youtube`
    Entry point: `youtube`

2. Click **Allow unauthenticated invocations** !!!

3. index.js and Replace `<YOUR_API_KEY_HERE>` (line 12)

    ```js
    'use strict';

    const {
    dialogflow,
    Image,
    Suggestions
    } = require('actions-on-google');

    const functions = require('firebase-functions');
    const app = dialogflow({debug: true});

    const API_KEY = '<YOUR_API_KEY_HERE>';

    app.intent('youtube', (conv, {any}) => {
        var url = "https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=5&q=" + encodeURIComponent(any)+ "&type=video&order=viewCount&videoCategoryId=10&key=" + API_KEY;
        const axios = require('axios');
        return axios.get(url)
            .then(response => {
            var output = JSON.stringify(response.data);
            var song_fields = response.data.items[1];
            return song_fields;
        }).then(output => {
                var song_title = output.snippet.title;
            song_title = song_title.replace(/&amp;/g, '&');
            song_title = song_title.replace(/&quot;/g, '\"');
            var song_link = JSON.stringify(output.id.videoId);
            var song_thumbnail = output.snippet.thumbnails.high.url;
            conv.ask(`Fetching your request...`)
            conv.ask(new Image({
                url: song_thumbnail,
                alt: 'Song thumbnail'
                }))
            conv.close(`The most popular song is: ` + song_title + `. The link to this song is: https://www.youtube.com/watch?v=` + song_link.slice(1, -1) + `. See you next time.`);
        })
    });

    exports.youtube = functions.https.onRequest(app);

    ```

4. package.json

    ```json
    {
        "name": "youtube",
        "description": "Get restaurant reviews.",
        "version": "0.0.1",
        "author": "Google Inc.",
        "engines": {
            "node": "8"
        },
        "dependencies": {
            "actions-on-google": "^2.0.0",
            "firebase-admin": "^4.2.1",
            "firebase-functions": "1.0.0",
            "axios": "0.16.2"
        }
    }

    ```

> **Check my progress**
> Initialize and Configure a Cloud Function

## Configure the Webhook

1. Copy the function URL

2. **Fulfillment** > Replace the dummy URL

## Test your Assistant Application with the Actions Simulator

1. Open [Activity Controls page](https://myaccount.google.com/activitycontrols)

2. TURN ON **Web & App Activity**.

### Test the application with the simulator

Enter `Talk to my test app` in the Input area

